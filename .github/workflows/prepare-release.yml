name: Prepare Release on Milestone Closure

on:
  milestone:
    types: [closed]

permissions: write-all

jobs:
  create-release-pr:
    if: ${{ github.event.milestone.open_issues == 0 && github.event.milestone.closed_issues > 0 }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: "Get Version from Milestone Title"
        id: get_version
        run: |
          # Extract version from milestone title
          VERSION="${{ github.event.milestone.title }}"
          echo "Milestone version: $VERSION"
          # Validate version format is X.Y.Z
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Milestone title '${VERSION}' is not a valid semantic version. Skipping."
            exit 0 # Exit normally, without error
          fi
          # Split version number
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          echo "major=${MAJOR}" >> $GITHUB_OUTPUT
          echo "minor=${MINOR}" >> $GITHUB_OUTPUT
          echo "patch=${PATCH}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update CMakeLists.txt Version
        # Only run if the version is successfully parsed
        if: steps.get_version.outputs.version
        run: |
          # Update the version number in CMakeLists.txt using sed
          sed -i "s/set(PROJECT_VERSION_MAJOR .*)/set(PROJECT_VERSION_MAJOR ${MAJOR})/g" CMakeLists.txt
          sed -i "s/set(PROJECT_VERSION_MINOR .*)/set(PROJECT_VERSION_MINOR ${MINOR})/g" CMakeLists.txt
          sed -i "s/set(PROJECT_VERSION_PATCH .*)/set(PROJECT_VERSION_PATCH ${PATCH})/g" CMakeLists.txt
        env:
          MAJOR: ${{ steps.get_version.outputs.major }}
          MINOR: ${{ steps.get_version.outputs.minor }}
          PATCH: ${{ steps.get_version.outputs.patch }}

      - name: Generate Release Notes
        if: steps.get_version.outputs.version
        uses: docker://decathlon/release-notes-generator-action:3.1.5
        id: release_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OUTPUT_FOLDER: release_notes # Output Release Notes to specific folder
          USE_MILESTONE_TITLE: "true"

      - name: Fix file permissions
        if: steps.get_version.outputs.version
        id: read_notes
        run: |
          cp release_notes/${{ steps.get_version.outputs.version }}.md docs/release_notes/
          sudo chown -R $(id -u):$(id -g) $GITHUB_WORKSPACE
          # Use special syntax to set up multi-line output
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat docs/release_notes/${{ steps.get_version.outputs.version }}.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.get_version.outputs.version
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ steps.get_version.outputs.version }}"
          title: "chore: bump to version ${{ steps.get_version.outputs.version }}"
          body: |
            This PR was automatically generated after closing milestone [${{ github.event.milestone.title }}](${{ github.event.milestone.html_url }})

            ${{ steps.read_notes.outputs.notes }}
          branch: "release/v${{ steps.get_version.outputs.version }}"
          base: "dev-xsan"
          labels: "release"
          add-paths: |
            docs/release_notes/${{ steps.get_version.outputs.version }}.md
            CMakeLists.txt

      - name: Create/Delete Milestones
        if: steps.get_version.outputs.version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          MAJOR: ${{ steps.get_version.outputs.major }}
          MINOR: ${{ steps.get_version.outputs.minor }}
          PATCH: ${{ steps.get_version.outputs.patch }}
        run: |
          set -e
          # Calculate the next version number
          NEXT_MAJOR=$((MAJOR + 1))
          NEXT_MINOR=$((MINOR + 1))
          NEXT_PATCH=$((PATCH + 1))

          # List of milestones to check/create
          MILESTONES_TO_CREATE=(
            "${NEXT_MAJOR}.0.0"
            "${MAJOR}.${NEXT_MINOR}.0"
            "${MAJOR}.${MINOR}.${NEXT_PATCH}"
          )

          # Fetch existing milestone titles using GitHub API
          EXISTING_TITLES=$(gh api repos/$GITHUB_REPOSITORY/milestones --jq '.[].title')

          # Fetch all open milestones
          EXISTING_OPEN_NUMBERS=$(gh api repos/$GITHUB_REPOSITORY/milestones \
                --paginate --jq '.[] | select(.state=="open") | "\(.number):\(.title)"')

          # Create new milestones (if not exist)
          for M in "${MILESTONES_TO_CREATE[@]}"; do
            if echo "$EXISTING_TITLES" | grep -Fxq "$M"; then
              echo "Milestone '$M' already exists, skipping."
            else
              echo "Creating milestone: $M"
              gh api repos/$GITHUB_REPOSITORY/milestones \
                -f title="$M" \
                -f state="open"
            fi
          done

          # Delete all milestones with version less than the current closed milestone
          # Current closed milestone version
          CURRENT_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          # Version comparison function, return 0 if $1 < $2
          version_lt() {
            # Use sort -V to compare
            [ "$(printf '%s\n%s\n' "$1" "$2" | sort -V | head -n1)" = "$1" ] && [ "$1" != "$2" ]
          }

          echo "Start deleting milestones with version less than $CURRENT_VERSION..."

          while IFS= read -r line; do
            NUMBER="${line%%:*}"
            TITLE="${line#*:}"
            # Skip milestones that are not in x.y.z format
            if [[ ! "$TITLE" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              continue
            fi
            # Skip current version
            if [[ "$TITLE" == "$CURRENT_VERSION" ]]; then
              continue
            fi
            if version_lt "$TITLE" "$CURRENT_VERSION"; then
              echo "Deleting milestone: $TITLE (number: $NUMBER)"
              gh api repos/$GITHUB_REPOSITORY/milestones/$NUMBER -X DELETE
            fi
          done <<< "$EXISTING_OPEN_NUMBERS"
        shell: bash
